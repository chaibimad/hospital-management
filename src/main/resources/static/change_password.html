<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Changer mot de passe</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f9; margin: 0; padding: 0; }
        .card { max-width: 520px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        h2 { margin-top: 0; }
        label { display:block; margin-top: 14px; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px; }
        .btn { margin-top: 18px; width: 100%; background: #3498db; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn:hover { background: #2980b9; }
        .msg { padding: 12px; border-radius: 6px; margin-bottom: 15px; display:none; }
        .msg.success { background: #d4edda; color: #155724; }
        .msg.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div id="app-main" class="card">
        <h2>ðŸ”’ Changer mon mot de passe</h2>
        <div id="msgSuccess" class="msg success"></div>
        <div id="msgError" class="msg error"></div>

        <form id="pwdForm">
            <label>Ancien mot de passe</label>
            <input type="password" id="oldPassword" required>

            <label>Nouveau mot de passe</label>
            <input type="password" id="newPassword" required>

            <label>Confirmer le nouveau mot de passe</label>
            <input type="password" id="confirmPassword" required>

            <button type="submit" class="btn">Enregistrer</button>
        </form>
    </div>

    <script>
        function showMsg(el, text) {
            el.textContent = text;
            el.style.display = 'block';
        }

        function hideMsgs() {
            document.getElementById('msgSuccess').style.display = 'none';
            document.getElementById('msgError').style.display = 'none';
        }

        document.getElementById('pwdForm').onsubmit = async (e) => {
            e.preventDefault();
            hideMsgs();

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 4) {
                showMsg(document.getElementById('msgError'), 'Le nouveau mot de passe doit contenir au moins 4 caractÃ¨res.');
                return;
            }
            if (newPassword !== confirmPassword) {
                showMsg(document.getElementById('msgError'), 'La confirmation ne correspond pas au nouveau mot de passe.');
                return;
            }

            try {
                const r = await fetch('/api/user/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                const data = await r.json().catch(() => ({}));
                if (!r.ok) {
                    showMsg(document.getElementById('msgError'), data.message || 'Erreur lors du changement de mot de passe.');
                    return;
                }

                showMsg(document.getElementById('msgSuccess'), data.message || 'Mot de passe modifiÃ© avec succÃ¨s.');
                document.getElementById('pwdForm').reset();
            } catch (err) {
                showMsg(document.getElementById('msgError'), 'Erreur rÃ©seau.');
            }
        };
    </script>
</body>
</html>
